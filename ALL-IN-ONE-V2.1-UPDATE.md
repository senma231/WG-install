# WireGuard All-in-One v2.1.0 重大更新

## 🎉 现在真正的"全能脚本"！

### 🆕 新增核心功能：端口转发管理

All-in-One脚本现在完全集成了端口转发功能，无需额外下载任何脚本！

#### 🔥 端口转发功能亮点

1. **完全集成** - 无需额外脚本，一个文件搞定所有功能
2. **智能管理** - 自动检测客户端状态，智能配置iptables规则
3. **故障排查** - 内置完整的故障诊断和自动修复功能
4. **安全优化** - 自动添加MASQUERADE规则，确保连接稳定

### 🚀 使用方法

#### 快速开始
```bash
# 下载最新版本
wget https://raw.githubusercontent.com/senma231/WG-install/main/wireguard-all-in-one.sh && chmod +x wireguard-all-in-one.sh && sudo ./wireguard-all-in-one.sh
```

#### 端口转发使用流程
1. 运行脚本：`sudo ./wireguard-all-in-one.sh`
2. 选择 "6. 端口转发管理 (通过公网IP访问客户端)"
3. 进入端口转发管理界面：
   - **添加端口转发规则** - 配置新的转发规则
   - **列出端口转发规则** - 查看所有规则和状态
   - **删除端口转发规则** - 删除不需要的规则
   - **端口转发故障排查** - 自动诊断和修复问题

### 📋 完整功能菜单

```
WireGuard 一体化全能脚本 v2.1.0

请选择操作：

1. 安装WireGuard服务端
2. 添加客户端 (支持Windows智能优化)
   ├─ Windows客户端 (MTU、DNS、流量模式优化)
   │  ├─ 全局代理模式 (所有流量通过VPN)
   │  └─ 内网访问模式 (仅访问服务端内网)
   └─ 其他客户端 (Linux/macOS/Android/iOS等)
3. 删除客户端
4. 列出所有客户端
5. 显示服务状态
6. 端口转发管理 (通过公网IP访问客户端) 🆕
   ├─ 添加端口转发规则
   ├─ 列出端口转发规则  
   ├─ 删除端口转发规则
   └─ 端口转发故障排查
7. 网络诊断
8. 卸载WireGuard
0. 退出
```

### 🎯 端口转发功能详解

#### 支持的服务类型
- **RDP (远程桌面)** - Windows远程桌面连接
- **SSH** - 远程命令行访问
- **HTTP/HTTPS** - Web服务访问
- **FTP** - 文件传输服务
- **自定义端口** - 任意TCP服务

#### 工作原理
```
外部用户 → 服务端公网IP:公网端口 → iptables转发 → WireGuard隧道 → 客户端:目标端口
```

#### 使用场景
1. **远程办公** - 通过RDP远程访问Windows桌面
2. **服务器管理** - 通过SSH管理Linux客户端
3. **Web服务** - 访问客户端上的Web应用
4. **文件传输** - 通过FTP等协议传输文件

### 🔧 技术特性

#### 智能规则管理
- **自动检测客户端状态** - 只对在线客户端创建规则
- **完整的iptables规则** - DNAT、FORWARD、INPUT、MASQUERADE
- **规则持久化** - 自动保存，重启后生效
- **冲突检测** - 避免端口冲突

#### 故障排查功能
- **服务状态检查** - WireGuard服务、IP转发状态
- **规则完整性验证** - 检查所有iptables规则
- **客户端连通性测试** - ping测试、端口连通性
- **自动修复** - 一键修复常见问题

#### 安全特性
- **端口占用检测** - 避免端口冲突
- **客户端状态验证** - 确保客户端在线
- **规则精确匹配** - 避免误删规则

### 📊 使用示例

#### 配置Windows远程桌面
```
1. 选择客户端: laptop (10.66.0.2) - 在线
2. 选择服务: RDP (远程桌面) - 3389
3. 设置公网端口: 13389 (推荐非标准端口)
4. 自动配置iptables规则
5. 连接方式: mstsc → 服务端IP:13389
```

#### 配置SSH访问
```
1. 选择客户端: server (10.66.0.3) - 在线  
2. 选择服务: SSH - 22
3. 设置公网端口: 2222
4. 连接方式: ssh user@服务端IP -p 2222
```

### 🛡️ 安全建议

#### 端口安全
- ✅ 使用非标准端口 (RDP用13389而不是3389)
- ✅ 定期更换端口配置
- ✅ 监控访问日志

#### 客户端安全
- ✅ 配置强密码和用户权限
- ✅ 启用Windows防火墙规则
- ✅ 定期更新系统和软件

#### 服务端安全
- ✅ 检查VPS提供商安全组设置
- ✅ 定期备份配置文件
- ✅ 监控异常连接

### 🔍 故障排查指南

#### 常见问题
1. **无法连接** - 检查VPS安全组、客户端防火墙
2. **连接超时** - 验证客户端在线状态、服务运行状态
3. **规则失效** - 运行自动修复功能

#### 自动诊断
脚本内置完整的故障排查功能：
- 检查WireGuard服务状态
- 验证IP转发设置
- 检查iptables规则完整性
- 测试客户端连通性
- 提供修复建议和自动修复

### 📈 性能优化

#### 网络优化
- **MASQUERADE规则** - 确保返回流量正确路由
- **精确的FORWARD规则** - 减少不必要的规则匹配
- **智能端口选择** - 避免端口冲突

#### 管理优化
- **规则持久化** - 自动保存到配置文件
- **状态实时显示** - 显示客户端在线/离线状态
- **批量操作支持** - 支持多个转发规则管理

### 🔄 升级说明

#### 从旧版本升级
1. **完全向后兼容** - 现有配置不受影响
2. **新功能自动可用** - 无需额外配置
3. **配置自动迁移** - 保持所有现有设置

#### 升级步骤
```bash
# 备份现有配置（可选）
sudo cp -r /etc/wireguard /etc/wireguard.backup

# 下载新版本
wget -O wireguard-all-in-one.sh https://raw.githubusercontent.com/senma231/WG-install/main/wireguard-all-in-one.sh

# 运行新版本
chmod +x wireguard-all-in-one.sh
sudo ./wireguard-all-in-one.sh
```

### 📚 相关文档

- **快捷命令参考**: `QUICK-COMMANDS.md`
- **Windows客户端指南**: `WINDOWS-CLIENT-GUIDE.md`
- **远程访问指南**: `WINDOWS-REMOTE-ACCESS-GUIDE.md`
- **使用指南**: `USAGE_GUIDE.md`

### 🎯 版本对比

| 功能 | v2.0.0 | v2.1.0 |
|------|--------|--------|
| WireGuard安装 | ✅ | ✅ |
| 客户端管理 | ✅ | ✅ |
| Windows优化 | ✅ | ✅ |
| 网络诊断 | ✅ | ✅ |
| 端口转发管理 | ❌ | ✅ |
| 故障自动修复 | ❌ | ✅ |
| 完全集成 | ❌ | ✅ |

### 🎉 总结

**v2.1.0是一个重大更新**，将端口转发功能完全集成到All-in-One脚本中，现在真正实现了"一个脚本搞定所有WireGuard需求"的目标。

**主要优势**：
- 🚀 **真正的全能脚本** - 无需额外下载任何文件
- 🔧 **完整的端口转发管理** - 添加、删除、故障排查一应俱全
- 🛡️ **智能安全特性** - 自动检测、智能配置、安全优化
- 🔍 **强大的故障排查** - 自动诊断、一键修复
- 📱 **完美的Windows支持** - 从客户端优化到远程访问全覆盖

**立即体验**：
```bash
wget https://raw.githubusercontent.com/senma231/WG-install/main/wireguard-all-in-one.sh && chmod +x wireguard-all-in-one.sh && sudo ./wireguard-all-in-one.sh
```

现在，一个脚本真正解决所有WireGuard需求！🎉
