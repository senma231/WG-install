# WireGuard 完整安装脚本

这是一个功能完整的WireGuard安装脚本，专门针对国内外网络环境进行了优化，提供完全交互式的操作界面。

## 功能特性

### 🌐 网络环境适配
- **智能网络检测**：自动检测国内/海外网络环境
- **镜像源优化**：国内环境自动配置阿里云等国内镜像源
- **DNS优化**：根据网络环境自动选择最优DNS服务器
- **网络连通性测试**：安装前进行全面的网络检测

### 🔧 系统优化
- **内核参数优化**：针对国内网络环境的BBR拥塞控制
- **防火墙自动配置**：支持UFW、firewalld、iptables
- **系统服务管理**：自动配置systemd服务
- **IP转发配置**：自动启用IPv4/IPv6转发

### 🛡️ 安全特性
- **智能私网段选择**：避免与VPS内网冲突的私网段
- **强密钥生成**：使用WireGuard原生密钥生成
- **配置文件权限**：严格的文件权限控制
- **防火墙安全规则**：最小权限原则

### 📱 客户端管理
- **多客户端支持**：支持添加/删除多个客户端
- **二维码生成**：自动生成客户端配置二维码
- **配置文件导出**：便于在各种设备上使用
- **在线状态监控**：实时显示客户端连接状态

### 🔄 备份恢复
- **配置备份**：一键备份所有配置文件
- **配置恢复**：支持从备份恢复配置
- **版本管理**：带时间戳的备份文件管理

### 🔍 诊断工具
- **网络诊断**：全面的网络连通性检测
- **服务状态监控**：实时显示WireGuard服务状态
- **故障排查**：自动检测常见问题

## 系统要求

### 支持的操作系统
- Ubuntu 18.04+
- Debian 9+
- CentOS 7+
- RHEL 7+
- Fedora 30+

### 系统架构
- x86_64 (amd64)
- ARM64 (aarch64)

### 网络要求
- 服务器需要有公网IP
- 开放UDP端口（默认51820）
- 支持iptables或相应防火墙

## 快速开始

### 1. 下载脚本
```bash
wget https://raw.githubusercontent.com/senma231/WG-install/main/deploy.sh
chmod +x deploy.sh
```

### 2. 运行脚本
```bash
sudo ./deploy.sh
```

### 3. 选择安装服务端
在主菜单中选择 `1. 安装WireGuard服务端`

### 4. 添加客户端
安装完成后，选择 `2. 添加客户端` 来创建客户端配置

## 详细使用说明

### 主菜单选项

1. **安装WireGuard服务端**
   - 自动检测系统环境
   - 配置网络优化参数
   - 生成服务端密钥
   - 配置防火墙规则

2. **添加客户端**
   - 输入客户端名称
   - 自动分配IP地址
   - 生成客户端配置文件
   - 显示配置二维码

3. **删除客户端**
   - 列出现有客户端
   - 选择要删除的客户端
   - 自动清理配置

4. **列出所有客户端**
   - 显示客户端列表
   - 显示IP地址和连接状态

5. **显示服务状态**
   - WireGuard服务状态
   - 网络接口信息
   - 连接统计信息

6. **备份配置**
   - 创建配置备份
   - 带时间戳的备份文件

7. **恢复配置**
   - 从备份恢复配置
   - 支持多个备份版本

8. **网络诊断**
   - 服务状态检查
   - 网络连通性测试
   - 防火墙规则检查

9. **卸载WireGuard**
   - 完全卸载WireGuard
   - 自动备份配置
   - 清理系统设置

### 网络优化特性

#### 国内网络优化
- 启用BBR拥塞控制算法
- 优化TCP/UDP缓冲区大小
- 启用TCP Fast Open
- 配置国内DNS服务器

#### 私网段选择
脚本提供以下私网段选项，避免与常见VPS内网冲突：
- `10.66.0.0/16` (推荐)
- `10.88.0.0/16`
- `172.31.0.0/16`
- `192.168.233.0/24`
- `192.168.188.0/24`

#### 防火墙配置
自动检测并配置以下防火墙：
- **UFW**: Ubuntu默认防火墙
- **firewalld**: CentOS/RHEL默认防火墙
- **iptables**: 通用防火墙规则

## 客户端配置

### 移动设备
1. 安装WireGuard客户端应用
2. 扫描脚本生成的二维码
3. 或手动导入配置文件

### 桌面设备
1. 下载客户端配置文件
2. 导入到WireGuard客户端
3. 连接VPN

### 配置文件位置
- 服务端配置：`/etc/wireguard/wg0.conf`
- 客户端配置：`/etc/wireguard/clients/`
- 备份文件：`/root/wireguard-backup/`

## 故障排查

### 常见问题

1. **服务启动失败**
   ```bash
   systemctl status wg-quick@wg0
   journalctl -u wg-quick@wg0
   ```

2. **客户端无法连接**
   - 检查防火墙设置
   - 验证端口是否开放
   - 检查服务器公网IP

3. **网络速度慢**
   - 运行网络诊断
   - 检查MTU设置
   - 验证BBR是否启用

### 日志查看
```bash
# 查看WireGuard日志
journalctl -u wg-quick@wg0 -f

# 查看系统日志
dmesg | grep wireguard
```

## 安全建议

1. **定期备份配置**
2. **使用强密码保护服务器**
3. **定期更新系统和WireGuard**
4. **监控异常连接**
5. **限制客户端数量**

## 更新和维护

### 脚本更新
```bash
wget -O deploy.sh https://raw.githubusercontent.com/senma231/WG-install/main/deploy.sh
chmod +x deploy.sh
```

### WireGuard更新
```bash
# Ubuntu/Debian
apt update && apt upgrade wireguard

# CentOS/RHEL
yum update wireguard-tools
```

## 许可证

本项目采用 MIT 许可证。

## 贡献

欢迎提交Issue和Pull Request来改进这个脚本。

## 支持

如果遇到问题，请：
1. 查看故障排查部分
2. 运行网络诊断功能
3. 提交Issue并附上日志信息

---

**注意**: 使用本脚本前请确保了解相关法律法规，合规使用VPN服务。
